# ============================================================================
# DUAL Z MOTORS CONFIGURATION
# ============================================================================

# This configuration synchronizes two Z stepper motors
# Z1 (left) and Z2 (right) will move together
# Configured for 400x400x400 CoreXY printer

# Z Stepper 1 (Left) - Already defined in main config
# [stepper_z] - step_pin: PB0, dir_pin: PC5, enable_pin: !PB1

# Z Stepper 2 (Right) - Already defined in main config  
# [stepper_z1] - step_pin: PA15, dir_pin: PA8, enable_pin: !PC6

# ============================================================================
# Z TILT ADJUST
# ============================================================================

# Z tilt adjust for dual Z motors on 400x400 bed
[z_tilt]
z_positions:
    -100, 100
    -100, 100
points:
    30, 30
    370, 30
    200, 200
    30, 370
    370, 370
speed: 400
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075

# ============================================================================
# DUAL Z CALIBRATION MACROS
# ============================================================================

[gcode_macro Z_TILT_ADJUST]
description: Adjust Z tilt using dual motors
gcode:
    M118 Starting Z tilt adjustment...
    Z_TILT_ADJUST
    M118 Z tilt adjustment complete

[gcode_macro DUAL_Z_HOME]
description: Home both Z motors
gcode:
    M118 Homing dual Z motors...
    G28 Z
    M118 Dual Z homing complete

[gcode_macro DUAL_Z_LEVEL]
description: Level the Z axis using the probe
gcode:
    M118 Starting Z leveling with probe...
    G28 Z
    Z_TILT_ADJUST
    M118 Z leveling complete

[gcode_macro DUAL_Z_ALIGN]
description: Align dual Z motors manually
gcode:
    M118 Manual Z alignment mode
    M118 Move Z up/down to align motors
    M118 Use M84 Z to disable steppers when done
    M118 Then run DUAL_Z_HOME to complete

# ============================================================================
# Z OFFSET CALIBRATION
# ============================================================================

[gcode_macro Z_OFFSET_CALIBRATE]
description: Calibrate Z offset with dual Z
gcode:
    M118 Starting Z offset calibration...
    G28 Z
    Z_TILT_ADJUST
    PROBE_CALIBRATE
    M118 Z offset calibration complete. Save with SAVE_CONFIG

# ============================================================================
# EMERGENCY Z ALIGNMENT
# ============================================================================

[gcode_macro EMERGENCY_Z_ALIGN]
description: Emergency Z alignment if motors get out of sync
gcode:
    M118 EMERGENCY Z ALIGNMENT
    M118 Disabling Z steppers...
    M84 Z
    M118 Manually align Z motors now
    M118 Then run DUAL_Z_HOME
    M118 WARNING: This may cause layer shifts if not done carefully

# ============================================================================
# Z MOTOR TESTING
# ============================================================================

[gcode_macro TEST_Z_MOTORS]
description: Test both Z motors individually
gcode:
    M118 Testing Z motors individually...
    
    # Test Z1 (left)
    M118 Testing Z1 (left motor)...
    G91
    G1 Z5 F300
    G1 Z-5 F300
    G90
    
    # Test Z2 (right)
    M118 Testing Z2 (right motor)...
    G91
    G1 Z5 F300
    G1 Z-5 F300
    G90
    
    M118 Z motor test complete

# ============================================================================
# Z MOTOR SYNC CHECK
# ============================================================================

[gcode_macro CHECK_Z_SYNC]
description: Check if Z motors are synchronized
gcode:
    M118 Checking Z motor synchronization...
    M118 Move Z up 10mm and check if both motors move together
    G91
    G1 Z10 F300
    G90
    M118 Check if both Z motors moved the same amount
    M118 If not synchronized, run EMERGENCY_Z_ALIGN 