# ============================================================================
# MOTOR SPECIFICATIONS CONFIGURATION
# ============================================================================
# Based on motor datasheets from https://github.com/JCorellaFSL/NecroCubicon
# 
# Motors used:
# - 17HS24-2104S for X/Y/E (CoreXY and extruder)
# - 17HE24-2104S for Z1/Z2 (dual Z motors)
#
# Optimized for high-speed CoreXY operation

# ============================================================================
# MOTOR SPECIFICATIONS
# ============================================================================

# 17HS24-2104S Specifications (X/Y/E motors)
# - Step angle: 1.8° (200 steps/rev)
# - Rated current: 2.1A
# - Rated voltage: 3.6V
# - Resistance: 1.7Ω
# - Inductance: 3.2mH
# - Holding torque: 0.4N⋅m
# - Detent torque: 0.02N⋅m
# - Rotor inertia: 54g⋅cm²
# - Weight: 280g

# 17HE24-2104S Specifications (Z motors)
# - Step angle: 1.8° (200 steps/rev)
# - Rated current: 2.1A
# - Rated voltage: 3.6V
# - Resistance: 1.7Ω
# - Inductance: 3.2mH
# - Holding torque: 0.4N⋅m
# - Detent torque: 0.02N⋅m
# - Rotor inertia: 54g⋅cm²
# - Weight: 280g

# ============================================================================
# ADVANCED TMC2209 SETTINGS FOR HIGH SPEED
# ============================================================================

# CoreXY Stepper A (17HS24-2104S)
[tmc2209 stepper_a]
uart_pin: PC1
tx_pin: PC1
uart_address: 0
run_current: 1.200
hold_current: 0.600
stealthchop_threshold: 999999
# High-speed optimization
tpwmthrs: 500
tpfd: 4
chm: 0
# Stall detection for homing
sg_stall_value: 100
sg_stall_result: 1

# CoreXY Stepper B (17HS24-2104S)
[tmc2209 stepper_b]
uart_pin: PC1
tx_pin: PC1
uart_address: 2
run_current: 1.200
hold_current: 0.600
stealthchop_threshold: 999999
# High-speed optimization
tpwmthrs: 500
tpfd: 4
chm: 0
# Stall detection for homing
sg_stall_value: 100
sg_stall_result: 1

# Z Stepper 1 (17HE24-2104S)
[tmc2209 stepper_z]
uart_pin: PC1
tx_pin: PC1
uart_address: 1
run_current: 1.000
hold_current: 0.500
stealthchop_threshold: 999999
# Z motor optimization
tpwmthrs: 500
tpfd: 4
chm: 0

# Z Stepper 2 (17HE24-2104S)
[tmc2209 stepper_z1]
uart_pin: PC1
tx_pin: PC1
uart_address: 3
run_current: 1.000
hold_current: 0.500
stealthchop_threshold: 999999
# Z motor optimization
tpwmthrs: 500
tpfd: 4
chm: 0

# Extruder (17HS24-2104S)
[tmc2209 extruder]
uart_pin: PC1
tx_pin: PC1
uart_address: 4
run_current: 0.800
hold_current: 0.400
stealthchop_threshold: 999999
# Extruder optimization
tpwmthrs: 500
tpfd: 4
chm: 0

# ============================================================================
# HIGH-SPEED PRINTER SETTINGS
# ============================================================================

# Updated printer settings for high-speed operation
[printer]
kinematics: corexy
max_velocity: 500
max_accel: 5000
max_accel_to_decel: 2500
max_z_velocity: 10
max_z_accel: 200

# ============================================================================
# ADVANCED STEPPER SETTINGS
# ============================================================================

# CoreXY Stepper A - High speed optimized
[stepper_a]
step_pin: PB13
dir_pin: PB12
enable_pin: !PB14
step_distance: 0.0125
endstop_pin: ^PC0
position_endstop: 0
position_max: 400
homing_speed: 100
second_homing_speed: 20
homing_retract_dist: 5

# CoreXY Stepper B - High speed optimized
[stepper_b]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
step_distance: 0.0125
endstop_pin: ^PC1
position_endstop: 0
position_max: 400
homing_speed: 100
second_homing_speed: 20
homing_retract_dist: 5

# Z Stepper 1 - Optimized for dual Z
[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
step_distance: 0.04
endstop_pin: probe:z_virtual_endstop
position_max: 400
position_min: -5

# Z Stepper 2 - Synchronized with Z1
[stepper_z1]
step_pin: PA15
dir_pin: PA8
enable_pin: !PC6
step_distance: 0.04

# Extruder - High speed optimized
[extruder]
step_pin: PB3
dir_pin: PB4
enable_pin: !PD1
step_distance: 0.0025
nozzle_diameter: 0.4
filament_diameter: 1.75
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control: pid
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: 0
max_temp: 250
pressure_advance: 0.0
pressure_advance_smooth_time: 0.040

# ============================================================================
# HIGH-SPEED MACROS
# ============================================================================

[gcode_macro MOTOR_TUNE_HIGH_SPEED]
description: Tune motors for high-speed operation
gcode:
    M118 Tuning motors for high-speed operation...
    
    # Set higher currents for CoreXY motors
    SET_TMC_CURRENT STEPPER=stepper_a CURRENT=1.2
    SET_TMC_CURRENT STEPPER=stepper_b CURRENT=1.2
    
    # Set Z motor currents
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT=1.0
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=1.0
    
    # Set extruder current
    SET_TMC_CURRENT STEPPER=extruder CURRENT=0.8
    
    M118 Motor tuning complete

[gcode_macro TEST_HIGH_SPEED]
description: Test high-speed movement
gcode:
    M118 Testing high-speed movement...
    
    # Test CoreXY at high speeds
    G1 X200 Y200 Z10 F5000
    G1 X50 Y50 F5000
    G1 X350 Y350 F5000
    G1 X50 Y350 F5000
    G1 X350 Y50 F5000
    G1 X200 Y200 F5000
    
    M118 High-speed test complete

[gcode_macro OPTIMIZE_FOR_SPEED]
description: Optimize all settings for high-speed printing
gcode:
    M118 Optimizing for high-speed printing...
    
    # Tune motors
    MOTOR_TUNE_HIGH_SPEED
    
    # Set high-speed parameters
    SET_VELOCITY_LIMIT VELOCITY=500 ACCEL=5000 ACCEL_TO_DECEL=2500
    
    # Optimize input shaper for speed
    SET_INPUT_SHAPER SHAPER_FREQ_X=60 SHAPER_FREQ_Y=60 SHAPER_TYPE=mzv
    
    M118 High-speed optimization complete

# ============================================================================
# MOTOR DIAGNOSTICS
# ============================================================================

[gcode_macro MOTOR_STATUS]
description: Show motor status and settings
gcode:
    M118 Motor Status:
    M118 CoreXY A: Current={driver_stepper_a.run_current}A, Temp={driver_stepper_a.temperature}°C
    M118 CoreXY B: Current={driver_stepper_b.run_current}A, Temp={driver_stepper_b.temperature}°C
    M118 Z1: Current={driver_stepper_z.run_current}A, Temp={driver_stepper_z.temperature}°C
    M118 Z2: Current={driver_stepper_z1.run_current}A, Temp={driver_stepper_z1.temperature}°C
    M118 Extruder: Current={driver_extruder.run_current}A, Temp={driver_extruder.temperature}°C

[gcode_macro MOTOR_TEMP_CHECK]
description: Check motor temperatures
gcode:
    M118 Motor Temperature Check:
    M118 CoreXY A: {driver_stepper_a.temperature}°C
    M118 CoreXY B: {driver_stepper_b.temperature}°C
    M118 Z1: {driver_stepper_z.temperature}°C
    M118 Z2: {driver_stepper_z1.temperature}°C
    M118 Extruder: {driver_extruder.temperature}°C
    
    # Warning if any motor is too hot
    {% if driver_stepper_a.temperature > 80 %}
        M118 WARNING: CoreXY A motor is hot!
    {% endif %}
    {% if driver_stepper_b.temperature > 80 %}
        M118 WARNING: CoreXY B motor is hot!
    {% endif %}
    {% if driver_stepper_z.temperature > 80 %}
        M118 WARNING: Z1 motor is hot!
    {% endif %}
    {% if driver_stepper_z1.temperature > 80 %}
        M118 WARNING: Z2 motor is hot!
    {% endif %}
    {% if driver_extruder.temperature > 80 %}
        M118 WARNING: Extruder motor is hot!
    {% endif %}

# ============================================================================
# PERFORMANCE PROFILES
# ============================================================================

[gcode_macro SET_PERFORMANCE_PROFILE]
description: Set performance profile (SPEED, BALANCED, QUALITY)
gcode:
    {% set profile = params.PROFILE|default('BALANCED')|upper %}
    
    {% if profile == 'SPEED' %}
        M118 Setting SPEED profile...
        SET_VELOCITY_LIMIT VELOCITY=500 ACCEL=5000 ACCEL_TO_DECEL=2500
        SET_TMC_CURRENT STEPPER=stepper_a CURRENT=1.2
        SET_TMC_CURRENT STEPPER=stepper_b CURRENT=1.2
        SET_TMC_CURRENT STEPPER=stepper_z CURRENT=1.0
        SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=1.0
        SET_TMC_CURRENT STEPPER=extruder CURRENT=0.8
        
    {% elif profile == 'BALANCED' %}
        M118 Setting BALANCED profile...
        SET_VELOCITY_LIMIT VELOCITY=300 ACCEL=3000 ACCEL_TO_DECEL=1500
        SET_TMC_CURRENT STEPPER=stepper_a CURRENT=1.0
        SET_TMC_CURRENT STEPPER=stepper_b CURRENT=1.0
        SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.8
        SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.8
        SET_TMC_CURRENT STEPPER=extruder CURRENT=0.7
        
    {% elif profile == 'QUALITY' %}
        M118 Setting QUALITY profile...
        SET_VELOCITY_LIMIT VELOCITY=200 ACCEL=2000 ACCEL_TO_DECEL=1000
        SET_TMC_CURRENT STEPPER=stepper_a CURRENT=0.8
        SET_TMC_CURRENT STEPPER=stepper_b CURRENT=0.8
        SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.6
        SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.6
        SET_TMC_CURRENT STEPPER=extruder CURRENT=0.6
        
    {% else %}
        M118 Invalid profile. Use SPEED, BALANCED, or QUALITY
    {% endif %}
    
    M118 Performance profile set to {profile} 